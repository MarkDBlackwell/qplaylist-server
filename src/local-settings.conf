# Copyright (C) 2022 Mark D. Blackwell.
#   All rights reserved.
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

RewriteEngine On

KeepAlive Off

# My home IP address
<LocationMatch "^/server-status$">
	SetHandler server-status
	Require ip 76.151.38.29  192.168.0.104
</LocationMatch>

# Redirect to WTMD
<LocationMatch "^/(index.html?|)$">
	RewriteRule ^ https://wtmd.org/radio [L,R=307]
</LocationMatch>

<Directory "/var/www/html/onair">
	Header set Cache-Control "no-cache, private, max-age=0, must-revalidate"
</Directory>

<Directory "/var/www/html/player">
	RewriteEngine On
</Directory>

<Directory "/var/www/html/player/dynamic">
	RewriteEngine On

	AddEncoding gzip .gz

	Header set Cache-Control "no-cache, private"

	RewriteRule ^LatestFive.html$ LatestFive.html.gz
	RewriteRule ^LatestFiveHD2.html$ LatestFiveHD2.html.gz

	# 06-28-17 Enable uploading precompressed QPlaylist song files.
	<FilesMatch "^LatestFive(HD2|)\.html\.gz$">
		# Serve correct encoding type.
		Header append Content-Encoding gzip

		# Force proxies to cache gzipped &
		# non-gzipped QPlaylist files separately.
		Header append Vary Accept-Encoding
	</FilesMatch>

	# If the client accepts gzip
	# and the requested gzip-compressed QPlaylist file exists...
	RewriteCond "%{HTTP:Accept-encoding}" gzip
	RewriteCond "%{REQUEST_FILENAME}.gz" -s
	# Append ".gz".
	RewriteRule "^LatestFive(HD2|)\.html$" "LatestFive$1.html.gz" [QSA]
	# Serve the correct media type, and prevent mod_deflate double gzip.
	RewriteRule "^LatestFive(HD2|)\.html\.gz$" "-" [T=text/html,E=no-gzip:1]
</Directory>

<Directory "/var/www/html/playlist">
	RewriteEngine On

	# 4-4-17 Megan - Trying to avoid empty html5 controls possibly caused by caching of mp3 file
	ExpiresActive off
</Directory>

<Directory "/var/www/html/playlist/dynamic">
	RewriteEngine On

	Header set Cache-Control "no-cache, private"

	AddEncoding gzip .gz

	RewriteRule ^LatestFive.html$ LatestFive.html.gz
	RewriteRule ^LatestFiveHD2.html$ LatestFiveHD2.html.gz

	RewriteRule ^RecentSongs.html$ RecentSongs.html.gz
	RewriteRule ^RecentSongsHD2.html$ RecentSongsHD2.html.gz

	RewriteRule ^NowPlaying.html$ NowPlaying.html.gz
	RewriteRule ^NowPlayingHD2.html$ NowPlayingHD2.html.gz

	# 06-28-17 Enable uploading precompressed QPlaylist song files.
	<FilesMatch "^(NowPlaying|LatestFive|RecentSongs)(HD2|)\.html\.gz$">
		# Serve correct encoding type.
		Header append Content-Encoding gzip

		# Force proxies to cache gzipped &
		# non-gzipped QPlaylist files separately.
		Header append Vary Accept-Encoding
	</FilesMatch>

	# If the client accepts gzip
	# and the requested gzip-compressed QPlaylist file exists...
	RewriteCond "%{HTTP:Accept-encoding}" gzip
	RewriteCond "%{REQUEST_FILENAME}.gz" -s
	# Append ".gz".
	RewriteRule "^(NowPlaying|LatestFive|RecentSongs)(HD2|)\.html$" "$1$2.html.gz" [QSA]
	# Serve the correct media type, and prevent mod_deflate double gzip.
	RewriteRule "^(NowPlaying|LatestFive|RecentSongs)(HD2|)\.html\.gz$" "-" [T=text/html,E=no-gzip:1]
</Directory>

<Directory "/var/www/html/remember">
	RewriteEngine On

	Header set Cache-Control "no-cache, private"

	RewriteRule ^LatestFew.json$ LatestFew.json.gz

	# 10-26-17 Within .htaccess, mod_rewrite requires FollowSymLinks.
	# See:
	#   https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html#rewriterule
	#   https://httpd.apache.org/docs/2.4/mod/core.html#options
	Options +FollowSymLinks

	# 09-16-17 On requests for append.json, invoke PHP.
	# This eases development by allowing access through the local filesystem.
	RewriteRule "^append\.json$" "append.php" [QSA]

	# 08-28-22 Redirect to main server to handle PHP.
	RewriteRule "^append\.php$" "%{REQUEST_SCHEME}://wtmd.org/remember/append.php" [QSA,L]

	## 11-03-17 The fact that Windows XP lacks TLS 1.1 (and 1.2)
	##   doesn't affect Remember Songs, because Windows XP
	##   also lacks Internet Explorer 10.
	## See:
	##   https://blogs.msdn.microsoft.com/kaushal/2011/10/02/support-for-ssltls-protocols-on-windows/

	# 11-03-17 Enable downloading of QPlaylist's precompressed
	#   JSON file which contains the latest few songs.
	<FilesMatch "^LatestFew\.json\.gz$">
		# Serve correct encoding type.
		Header append Content-Encoding gzip

		# Force proxies to cache gzipped &
		# non-gzipped QPlaylist files separately.
		Header append Vary Accept-Encoding
	</FilesMatch>

	# If the client accepts gzip
	# and the requested gzip-compressed QPlaylist file exists...
	RewriteCond "%{HTTP:Accept-encoding}" gzip
	RewriteCond "%{REQUEST_FILENAME}.gz" -s
	# Append ".gz".
	RewriteRule "^LatestFew\.json$" "LatestFew.json.gz" [QSA]
	# Serve the correct media type, and prevent mod_deflate double gzip.
	RewriteRule "^LatestFew\.json\.gz$" "-" [T=application/json,E=no-gzip:1]
</Directory>

<Directory "/var/www/html/wtmdapp">
	RewriteEngine On

	# Disable https
	RewriteCond %{HTTPS} on
	#RewriteCond %{REQUEST_URI} ^/wtmdapp
	RewriteRule ^ http://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

	Header set Cache-Control "no-cache, private"

	RewriteRule ^LatestFive.json$ LatestFive.json.gz
	RewriteRule ^LatestFiveHD2.json$ LatestFiveHD2.json.gz

	# 06-14-17 Enable precompressed QPlaylist song files.
	<FilesMatch "^LatestFive(HD2|)\.json\.gz$">
		# Serve correct encoding type.
		Header append Content-Encoding gzip

		# Force proxies to cache gzipped &
		# non-gzipped QPlaylist files separately.
		Header append Vary Accept-Encoding
	</FilesMatch>

	# If the gzip compressed QPlaylist files exist
	# and the client accepts gzip...
	RewriteCond "%{HTTP:Accept-encoding}" gzip
	RewriteCond "%{REQUEST_FILENAME}.gz" -s
	# Append ".gz".
	RewriteRule "^LatestFive(HD2|)\.json$" "LatestFive$1.json.gz" [QSA]
	# Serve the correct media type, and prevent mod_deflate double gzip.
	RewriteRule "^LatestFive(HD2|)\.json\.gz$" "-" [T=application/json,E=no-gzip:1]
</Directory>
